generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum CertEventType {
  CREATED
  REDEEMED
  PARTIAL_REDEEM
  EXPIRED
  CANCELED
  ADJUSTED
}

model cards {
  id         BigInt   @id @default(autoincrement())
  name       String
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)
  user_id    BigInt
  user       users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model certs {
  id         BigInt    @id @default(autoincrement())
  card_id    BigInt
  code       String    @unique(map: "certs_code_uq") @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recipient  String
  amount     Decimal   @db.Decimal(12, 2)
  balance    Decimal   @db.Decimal(12, 2)
  issued_at  DateTime  @db.Date
  expires_at DateTime? @db.Date
  status     String
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @default(now()) @db.Timestamptz(6)
  cert_events cert_events[]
}

model users {
  id             BigInt           @id @default(autoincrement())
  email          String?          @unique
  name           String?
  avatar_url     String?
  created_at     DateTime         @default(now()) @db.Timestamptz(6)
  updated_at     DateTime         @default(now()) @db.Timestamptz(6)
  oauth_accounts oauth_accounts[]
  sessions       sessions[]
  cards          cards[]
}

model oauth_accounts {
  id                BigInt    @id @default(autoincrement())
  user_id           BigInt
  provider          String
  provider_user_id  String
  email_at_provider String?
  access_token      String?
  refresh_token     String?
  expires_at        DateTime? @db.Timestamptz(6)
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @default(now()) @db.Timestamptz(6)
  user              users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_user_id])
  @@unique([user_id, provider])
}

model sessions {
  id                 BigInt   @id @default(autoincrement())
  user_id            BigInt
  refresh_token_hash String
  user_agent         String?
  ip                 String?  @db.Inet
  expires_at         DateTime @db.Timestamptz(6)
  created_at         DateTime @default(now()) @db.Timestamptz(6)
  user               users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model cert_events {
  id            BigInt         @id @default(autoincrement())
  cert_id       BigInt
  event_type    CertEventType
  amount_delta  Decimal?       @db.Decimal(12, 2) // отрицательное значение для погашения, положительное значение для корректировок
  balance_after Decimal?       @db.Decimal(12, 2) // Снимок баланса после операции
  note          String?
  created_at    DateTime       @default(now()) @db.Timestamptz(6)

  cert certs @relation(fields: [cert_id], references: [id], onDelete: Cascade)

  @@index([cert_id])
  @@index([event_type, created_at])
}
